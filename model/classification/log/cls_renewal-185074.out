=============================================
[INFO] Job Information
---------------------------------------------
[INFO] Job Name       : cls_framework
[INFO] Job ID         : 185074
[INFO] Submit Dir     : /home/cseomoon/appl/af_analysis-0.1.4/model/classification/scripts
[INFO] Partition      : a5000_short
[INFO] Node List      : gpu2
[INFO] Nodes          : 1
[INFO] CPUs per Task  : 40
[INFO] Memory (MB)    : 
[INFO] User           : cseomoon
[INFO] Work Dir       : /home/cseomoon/appl/af_analysis-0.1.4/model/classification/scripts
[INFO] Tasks per Node : 1
[INFO] Dependency     : 
[INFO] GPU(s)         : 
=============================================

[INFO] Job started at : Tue Apr 29 04:29:33 KST 2025
[INFO] Job allocated on node(s): gpu2
[INFO] Job running on: gpu2
[INFO] Results will be saved to: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933
Using 40 CPU cores.
Results will be saved to: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/run_arguments.json

--- Loading Data ---
Original data shape: (3650, 81)
Class distribution before NaN drop (DockQ >= 0.23): 0 (Negative) = 2529, 1 (Positive) = 1121
Identified 63 potential feature columns.
Checking for NaN values in potential feature columns...
Dropped 3 rows containing NaN values in one or more feature columns.
Processed Features (X) shape after NaN drop: (3647, 63)
Processed Target (y) shape after NaN drop: (3647,)
Processed Query IDs shape after NaN drop: (3647,)
Class distribution after NaN drop (DockQ >= 0.23): 0 (Negative) = 2526, 1 (Positive) = 1121
Data Loading & Preprocessing Duration: 0.06 seconds

--- Starting Model Training ---

--- Running Nested CV for: Random Forest (rf) ---
Output directory: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf
Using StratifiedGroupKFold for outer CV with 5 folds based on query IDs and stratified by y.

-- Processing Outer Fold 1/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 150 to 3297
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'n_estimators': 300, 'min_samples_split': 2, 'min_samples_leaf': 2, 'max_features': 'log2', 'max_depth': 40, 'class_weight': 'balanced'}
Best Inner CV PR-AUC score: 0.9085
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_1/best_params.json
CV metrics for best model: PR-AUC=0.9085, ROC-AUC=0.9492, F1=0.7804, Balanced Acc=0.8328
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_1/cv_metrics.json
Hyperparameter Tuning Duration: 52.28 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_1/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_1/predictions.csv
Default threshold (0.5): F1=0.9284
Optimal threshold (0.4394): F1=0.9416
Prediction & Evaluation Duration: 0.27 seconds
Calculating and saving SHAP values...
Calculating SHAP values for RandomForest using TreeExplainer...
Returning SHAP values for the positive class (from 3D array).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_1/shap_values_fold_1.csv (shape: (699, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_1/test_data_fold_1.csv (shape: (699, 63))
SHAP Calculation & Saving Duration: 6.20 seconds
-- Outer Fold 1 finished. Duration: 58.76 seconds --

-- Processing Outer Fold 2/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 50 to 3596
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'n_estimators': 100, 'min_samples_split': 2, 'min_samples_leaf': 1, 'max_features': 'log2', 'max_depth': 40, 'class_weight': None}
Best Inner CV PR-AUC score: 0.9365
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_2/best_params.json
CV metrics for best model: PR-AUC=0.9365, ROC-AUC=0.9595, F1=0.8370, Balanced Acc=0.8785
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_2/cv_metrics.json
Hyperparameter Tuning Duration: 47.43 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_2/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_2/predictions.csv
Default threshold (0.5): F1=0.4294
Optimal threshold (0.1600): F1=0.5465
Using optimal threshold (0.1600) for better F1 score
Prediction & Evaluation Duration: 0.10 seconds
Calculating and saving SHAP values...
Calculating SHAP values for RandomForest using TreeExplainer...
Returning SHAP values for the positive class (from 3D array).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_2/shap_values_fold_2.csv (shape: (750, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_2/test_data_fold_2.csv (shape: (750, 63))
SHAP Calculation & Saving Duration: 2.74 seconds
-- Outer Fold 2 finished. Duration: 50.32 seconds --

-- Processing Outer Fold 3/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 100 to 3446
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'n_estimators': 100, 'min_samples_split': 5, 'min_samples_leaf': 2, 'max_features': 'log2', 'max_depth': 50, 'class_weight': 'balanced_subsample'}
Best Inner CV PR-AUC score: 0.8925
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_3/best_params.json
CV metrics for best model: PR-AUC=0.8925, ROC-AUC=0.9482, F1=0.8330, Balanced Acc=0.8779
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_3/cv_metrics.json
Hyperparameter Tuning Duration: 44.71 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_3/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_3/predictions.csv
Default threshold (0.5): F1=0.6023
Optimal threshold (0.1974): F1=0.7972
Using optimal threshold (0.1974) for better F1 score
Prediction & Evaluation Duration: 0.11 seconds
Calculating and saving SHAP values...
Calculating SHAP values for RandomForest using TreeExplainer...
Returning SHAP values for the positive class (from 3D array).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_3/shap_values_fold_3.csv (shape: (750, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_3/test_data_fold_3.csv (shape: (750, 63))
SHAP Calculation & Saving Duration: 1.94 seconds
-- Outer Fold 3 finished. Duration: 46.82 seconds --

-- Processing Outer Fold 4/5 --
Train set size: (2898, 63), Test set size: (749, 63)
Test set indices range from 0 to 3546
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'n_estimators': 300, 'min_samples_split': 5, 'min_samples_leaf': 2, 'max_features': 'log2', 'max_depth': 40, 'class_weight': None}
Best Inner CV PR-AUC score: 0.8914
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_4/best_params.json
CV metrics for best model: PR-AUC=0.8914, ROC-AUC=0.9300, F1=0.8118, Balanced Acc=0.8585
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_4/cv_metrics.json
Hyperparameter Tuning Duration: 50.49 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_4/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_4/predictions.csv
Default threshold (0.5): F1=0.8280
Optimal threshold (0.7340): F1=0.9461
Using optimal threshold (0.7340) for better F1 score
Prediction & Evaluation Duration: 0.35 seconds
Calculating and saving SHAP values...
Calculating SHAP values for RandomForest using TreeExplainer...
Returning SHAP values for the positive class (from 3D array).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_4/shap_values_fold_4.csv (shape: (749, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_4/test_data_fold_4.csv (shape: (749, 63))
SHAP Calculation & Saving Duration: 6.55 seconds
-- Outer Fold 4 finished. Duration: 57.41 seconds --

-- Processing Outer Fold 5/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 350 to 3646
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'n_estimators': 200, 'min_samples_split': 5, 'min_samples_leaf': 1, 'max_features': 'log2', 'max_depth': 30, 'class_weight': 'balanced_subsample'}
Best Inner CV PR-AUC score: 0.8299
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_5/best_params.json
CV metrics for best model: PR-AUC=0.8299, ROC-AUC=0.9021, F1=0.7137, Balanced Acc=0.8017
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_5/cv_metrics.json
Hyperparameter Tuning Duration: 49.19 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_5/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_5/predictions.csv
Default threshold (0.5): F1=0.8846
Optimal threshold (0.3093): F1=0.9047
Prediction & Evaluation Duration: 0.25 seconds
Calculating and saving SHAP values...
Calculating SHAP values for RandomForest using TreeExplainer...
Returning SHAP values for the positive class (from 3D array).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_5/shap_values_fold_5.csv (shape: (699, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/fold_5/test_data_fold_5.csv (shape: (699, 63))
SHAP Calculation & Saving Duration: 4.19 seconds
-- Outer Fold 5 finished. Duration: 53.71 seconds --

--- Aggregating results for: Random Forest (rf) ---
Average Metrics across folds:
{
    "accuracy_mean": 0.8636838940236959,
    "accuracy_std": 0.07113797763933424,
    "precision_mean": 0.7650278985514701,
    "precision_std": 0.2295067393679026,
    "recall_mean": 0.7196651899654022,
    "recall_std": 0.17295712465971239,
    "f1_mean": 0.7345589422429311,
    "f1_std": 0.1894373792397089,
    "roc_auc_mean": 0.9298613332764397,
    "roc_auc_std": 0.05597738176040908,
    "pr_auc_mean": 0.8643369509596559,
    "pr_auc_std": 0.14558402377784693,
    "balanced_accuracy_mean": 0.8207669054670129,
    "balanced_accuracy_std": 0.11145900142227413,
    "mcc_mean": 0.6493833073253155,
    "mcc_std": 0.23155471519722726,
    "best_inner_cv_pr_auc_mean": 0.8917836608886791,
    "best_inner_cv_pr_auc_std": 0.034952324542696284,
    "default_threshold_mean": 0.5,
    "default_threshold_std": 0.0,
    "optimal_threshold_mean": 0.3680308031843193,
    "optimal_threshold_std": 0.20729488254395836,
    "optimal_f1_mean": 0.8272229687622529,
    "optimal_f1_std": 0.15026632559290434,
    "threshold_improvement_mean": 0.09266402651932173,
    "threshold_improvement_std": 0.06824497722557737,
    "threshold_used_mean": 0.5,
    "threshold_used_std": 0.0
}
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/metrics_summary.json
Combined predictions saved to: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/rf/all_predictions.csv

Running global SHAP analysis...
Combined SHAP values shape: (3647, 63)
Combined test data shape: (3647, 63)
Global SHAP analysis completed using data from all 5 folds
Global SHAP Analysis Duration: 1.78 seconds
Result Aggregation & Global SHAP Duration: 1.90 seconds
Average time per outer fold: 53.41 seconds
--- Nested CV completed for: Random Forest (rf) ---
Total execution time for model 'rf': 268.97 seconds

--- Running Nested CV for: XGBoost (xgb) ---
Output directory: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/xgb
Using StratifiedGroupKFold for outer CV with 5 folds based on query IDs and stratified by y.

-- Processing Outer Fold 1/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 150 to 3297
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Error during RandomizedSearchCV in fold 1: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11)}
Traceback (most recent call last):
  File "/home/cseomoon/appl/af_analysis-0.1.4/model/classification/train_models.py", line 170, in run_nested_cv
    search.fit(X_train, y_train) # Fit on the outer training data
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/base.py", line 1389, in wrapper
    return fit_method(estimator, *args, **kwargs)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1024, in fit
    self._run_search(evaluate_candidates)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1951, in _run_search
    evaluate_candidates(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 970, in evaluate_candidates
    out = parallel(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/utils/parallel.py", line 77, in __call__
    return super().__call__(iterable_with_config)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 2007, in __call__
    return output if self.return_generator else list(output)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1650, in _get_outputs
    yield from self._retrieve()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1754, in _retrieve
    self._raise_error_fast()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1789, in _raise_error_fast
    error_job.get_result(self.timeout)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 745, in get_result
    return self._return_or_raise()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 763, in _return_or_raise
    raise self._result
joblib.externals.loky.process_executor.TerminatedWorkerError: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11)}

Hyperparameter Tuning (Error) Duration: 1.76 seconds

-- Processing Outer Fold 2/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 50 to 3596
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Error during RandomizedSearchCV in fold 2: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11)}
Traceback (most recent call last):
  File "/home/cseomoon/appl/af_analysis-0.1.4/model/classification/train_models.py", line 170, in run_nested_cv
    search.fit(X_train, y_train) # Fit on the outer training data
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/base.py", line 1389, in wrapper
    return fit_method(estimator, *args, **kwargs)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1024, in fit
    self._run_search(evaluate_candidates)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1951, in _run_search
    evaluate_candidates(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 970, in evaluate_candidates
    out = parallel(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/utils/parallel.py", line 77, in __call__
    return super().__call__(iterable_with_config)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 2007, in __call__
    return output if self.return_generator else list(output)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1650, in _get_outputs
    yield from self._retrieve()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1754, in _retrieve
    self._raise_error_fast()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1789, in _raise_error_fast
    error_job.get_result(self.timeout)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 745, in get_result
    return self._return_or_raise()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 763, in _return_or_raise
    raise self._result
joblib.externals.loky.process_executor.TerminatedWorkerError: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11)}

Hyperparameter Tuning (Error) Duration: 13.60 seconds

-- Processing Outer Fold 3/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 100 to 3446
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Error during RandomizedSearchCV in fold 3: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11), SIGSEGV(-11)}
Traceback (most recent call last):
  File "/home/cseomoon/appl/af_analysis-0.1.4/model/classification/train_models.py", line 170, in run_nested_cv
    search.fit(X_train, y_train) # Fit on the outer training data
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/base.py", line 1389, in wrapper
    return fit_method(estimator, *args, **kwargs)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1024, in fit
    self._run_search(evaluate_candidates)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1951, in _run_search
    evaluate_candidates(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 970, in evaluate_candidates
    out = parallel(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/utils/parallel.py", line 77, in __call__
    return super().__call__(iterable_with_config)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 2007, in __call__
    return output if self.return_generator else list(output)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1650, in _get_outputs
    yield from self._retrieve()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1754, in _retrieve
    self._raise_error_fast()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1789, in _raise_error_fast
    error_job.get_result(self.timeout)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 745, in get_result
    return self._return_or_raise()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 763, in _return_or_raise
    raise self._result
joblib.externals.loky.process_executor.TerminatedWorkerError: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11), SIGSEGV(-11)}

Hyperparameter Tuning (Error) Duration: 6.83 seconds

-- Processing Outer Fold 4/5 --
Train set size: (2898, 63), Test set size: (749, 63)
Test set indices range from 0 to 3546
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Error during RandomizedSearchCV in fold 4: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11), SIGSEGV(-11)}
Traceback (most recent call last):
  File "/home/cseomoon/appl/af_analysis-0.1.4/model/classification/train_models.py", line 170, in run_nested_cv
    search.fit(X_train, y_train) # Fit on the outer training data
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/base.py", line 1389, in wrapper
    return fit_method(estimator, *args, **kwargs)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1024, in fit
    self._run_search(evaluate_candidates)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1951, in _run_search
    evaluate_candidates(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 970, in evaluate_candidates
    out = parallel(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/utils/parallel.py", line 77, in __call__
    return super().__call__(iterable_with_config)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 2007, in __call__
    return output if self.return_generator else list(output)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1650, in _get_outputs
    yield from self._retrieve()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1754, in _retrieve
    self._raise_error_fast()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1789, in _raise_error_fast
    error_job.get_result(self.timeout)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 745, in get_result
    return self._return_or_raise()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 763, in _return_or_raise
    raise self._result
joblib.externals.loky.process_executor.TerminatedWorkerError: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11), SIGSEGV(-11)}

Hyperparameter Tuning (Error) Duration: 3.71 seconds

-- Processing Outer Fold 5/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 350 to 3646
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Error during RandomizedSearchCV in fold 5: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11)}
Traceback (most recent call last):
  File "/home/cseomoon/appl/af_analysis-0.1.4/model/classification/train_models.py", line 170, in run_nested_cv
    search.fit(X_train, y_train) # Fit on the outer training data
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/base.py", line 1389, in wrapper
    return fit_method(estimator, *args, **kwargs)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1024, in fit
    self._run_search(evaluate_candidates)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 1951, in _run_search
    evaluate_candidates(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/model_selection/_search.py", line 970, in evaluate_candidates
    out = parallel(
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/sklearn/utils/parallel.py", line 77, in __call__
    return super().__call__(iterable_with_config)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 2007, in __call__
    return output if self.return_generator else list(output)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1650, in _get_outputs
    yield from self._retrieve()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1754, in _retrieve
    self._raise_error_fast()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 1789, in _raise_error_fast
    error_job.get_result(self.timeout)
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 745, in get_result
    return self._return_or_raise()
  File "/home/cseomoon/miniconda3/envs/Abnb/lib/python3.10/site-packages/joblib/parallel.py", line 763, in _return_or_raise
    raise self._result
joblib.externals.loky.process_executor.TerminatedWorkerError: A worker process managed by the executor was unexpectedly terminated. This could be caused by a segmentation fault while calling the function or by an excessive memory usage causing the Operating System to kill the worker.

The exit codes of the workers are {SIGSEGV(-11), SIGSEGV(-11)}

Hyperparameter Tuning (Error) Duration: 7.73 seconds

Error: No metrics were collected for model xgb. Check logs for errors in folds.
Total execution time for model 'xgb': 33.97 seconds

--- Running Nested CV for: LightGBM (lgb) ---
Output directory: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb
Using StratifiedGroupKFold for outer CV with 5 folds based on query IDs and stratified by y.

-- Processing Outer Fold 1/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 150 to 3297
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'subsample': 1.0, 'reg_lambda': 0.1, 'reg_alpha': 0.5, 'num_leaves': 40, 'n_estimators': 500, 'max_depth': -1, 'learning_rate': 0.1, 'colsample_bytree': 0.8, 'class_weight': 'balanced'}
Best Inner CV PR-AUC score: 0.9070
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_1/best_params.json
CV metrics for best model: PR-AUC=0.9070, ROC-AUC=0.9472, F1=0.7612, Balanced Acc=0.8248
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_1/cv_metrics.json
Hyperparameter Tuning Duration: 614.10 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_1/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_1/predictions.csv
Default threshold (0.5): F1=0.8939
Optimal threshold (0.9005): F1=0.9266
Prediction & Evaluation Duration: 0.30 seconds
Calculating and saving SHAP values...
Calculating SHAP values for LightGBM using TreeExplainer...
Warning: TreeExplainer returned a 2D array for LightGBM. Assuming it relates to the positive class.
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_1/shap_values_fold_1.csv (shape: (699, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_1/test_data_fold_1.csv (shape: (699, 63))
SHAP Calculation & Saving Duration: 0.62 seconds
-- Outer Fold 1 finished. Duration: 615.03 seconds --

-- Processing Outer Fold 2/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 50 to 3596
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'subsample': 0.6, 'reg_lambda': 0.1, 'reg_alpha': 0, 'num_leaves': 60, 'n_estimators': 100, 'max_depth': 30, 'learning_rate': 0.05, 'colsample_bytree': 0.6, 'class_weight': None}
Best Inner CV PR-AUC score: 0.9237
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_2/best_params.json
CV metrics for best model: PR-AUC=0.9237, ROC-AUC=0.9492, F1=0.8129, Balanced Acc=0.8595
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_2/cv_metrics.json
Hyperparameter Tuning Duration: 522.42 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_2/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_2/predictions.csv
Default threshold (0.5): F1=0.4182
Optimal threshold (0.0316): F1=0.5517
Using optimal threshold (0.0316) for better F1 score
Prediction & Evaluation Duration: 0.14 seconds
Calculating and saving SHAP values...
Calculating SHAP values for LightGBM using TreeExplainer...
Warning: TreeExplainer returned a 2D array for LightGBM. Assuming it relates to the positive class.
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_2/shap_values_fold_2.csv (shape: (750, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_2/test_data_fold_2.csv (shape: (750, 63))
SHAP Calculation & Saving Duration: 0.53 seconds
-- Outer Fold 2 finished. Duration: 523.12 seconds --

-- Processing Outer Fold 3/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 100 to 3446
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'subsample': 0.8, 'reg_lambda': 0, 'reg_alpha': 0, 'num_leaves': 50, 'n_estimators': 100, 'max_depth': 10, 'learning_rate': 0.2, 'colsample_bytree': 0.8, 'class_weight': None}
Best Inner CV PR-AUC score: 0.9164
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_3/best_params.json
CV metrics for best model: PR-AUC=0.9164, ROC-AUC=0.9434, F1=0.8435, Balanced Acc=0.8831
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_3/cv_metrics.json
Hyperparameter Tuning Duration: 422.60 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_3/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_3/predictions.csv
Default threshold (0.5): F1=0.6141
Optimal threshold (0.0003): F1=0.7624
Using optimal threshold (0.0003) for better F1 score
Prediction & Evaluation Duration: 0.12 seconds
Calculating and saving SHAP values...
Calculating SHAP values for LightGBM using TreeExplainer...
Warning: TreeExplainer returned a 2D array for LightGBM. Assuming it relates to the positive class.
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_3/shap_values_fold_3.csv (shape: (750, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_3/test_data_fold_3.csv (shape: (750, 63))
SHAP Calculation & Saving Duration: 0.44 seconds
-- Outer Fold 3 finished. Duration: 423.17 seconds --

-- Processing Outer Fold 4/5 --
Train set size: (2898, 63), Test set size: (749, 63)
Test set indices range from 0 to 3546
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'subsample': 1.0, 'reg_lambda': 0.1, 'reg_alpha': 0.5, 'num_leaves': 20, 'n_estimators': 500, 'max_depth': -1, 'learning_rate': 0.2, 'colsample_bytree': 1.0, 'class_weight': 'balanced'}
Best Inner CV PR-AUC score: 0.8932
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_4/best_params.json
CV metrics for best model: PR-AUC=0.8932, ROC-AUC=0.9327, F1=0.8117, Balanced Acc=0.8596
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_4/cv_metrics.json
Hyperparameter Tuning Duration: 610.84 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_4/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_4/predictions.csv
Default threshold (0.5): F1=0.8298
Optimal threshold (0.9906): F1=0.9000
Using optimal threshold (0.9906) for better F1 score
Prediction & Evaluation Duration: 0.11 seconds
Calculating and saving SHAP values...
Calculating SHAP values for LightGBM using TreeExplainer...
Warning: TreeExplainer returned a 2D array for LightGBM. Assuming it relates to the positive class.
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_4/shap_values_fold_4.csv (shape: (749, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_4/test_data_fold_4.csv (shape: (749, 63))
SHAP Calculation & Saving Duration: 0.32 seconds
-- Outer Fold 4 finished. Duration: 611.30 seconds --

-- Processing Outer Fold 5/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 350 to 3646
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'subsample': 0.8, 'reg_lambda': 1, 'reg_alpha': 0.5, 'num_leaves': 50, 'n_estimators': 500, 'max_depth': 30, 'learning_rate': 0.05, 'colsample_bytree': 0.6, 'class_weight': None}
Best Inner CV PR-AUC score: 0.8232
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_5/best_params.json
CV metrics for best model: PR-AUC=0.8232, ROC-AUC=0.8935, F1=0.7299, Balanced Acc=0.8153
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_5/cv_metrics.json
Hyperparameter Tuning Duration: 470.08 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_5/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_5/predictions.csv
Default threshold (0.5): F1=0.9013
Optimal threshold (0.3409): F1=0.9044
Prediction & Evaluation Duration: 0.17 seconds
Calculating and saving SHAP values...
Calculating SHAP values for LightGBM using TreeExplainer...
Warning: TreeExplainer returned a 2D array for LightGBM. Assuming it relates to the positive class.
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_5/shap_values_fold_5.csv (shape: (699, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/fold_5/test_data_fold_5.csv (shape: (699, 63))
SHAP Calculation & Saving Duration: 0.67 seconds
-- Outer Fold 5 finished. Duration: 470.93 seconds --

--- Aggregating results for: LightGBM (lgb) ---
Average Metrics across folds:
{
    "accuracy_mean": 0.8594313172928713,
    "accuracy_std": 0.06915516233552181,
    "precision_mean": 0.7446820266075873,
    "precision_std": 0.2151874973450442,
    "recall_mean": 0.7295881359149541,
    "recall_std": 0.17597577977349163,
    "f1_mean": 0.7314423692090046,
    "f1_std": 0.18804645744303677,
    "roc_auc_mean": 0.9223683510912034,
    "roc_auc_std": 0.05769897164057258,
    "pr_auc_mean": 0.8434987854402227,
    "pr_auc_std": 0.15482269357595535,
    "balanced_accuracy_mean": 0.8191297407202228,
    "balanced_accuracy_std": 0.1105711132609974,
    "mcc_mean": 0.6397552548157293,
    "mcc_std": 0.2259731745804951,
    "best_inner_cv_pr_auc_mean": 0.892691647268643,
    "best_inner_cv_pr_auc_std": 0.03622874330255734,
    "default_threshold_mean": 0.5,
    "default_threshold_std": 0.0,
    "optimal_threshold_mean": 0.4527788633015918,
    "optimal_threshold_std": 0.42056407024506826,
    "optimal_f1_mean": 0.8090259540908628,
    "optimal_f1_std": 0.14113157435341503,
    "threshold_improvement_mean": 0.07758358488185815,
    "threshold_improvement_std": 0.05609891898225117,
    "threshold_used_mean": 0.5,
    "threshold_used_std": 0.0
}
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/metrics_summary.json
Combined predictions saved to: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/lgb/all_predictions.csv

Running global SHAP analysis...
Combined SHAP values shape: (3647, 63)
Combined test data shape: (3647, 63)
Global SHAP analysis completed using data from all 5 folds
Global SHAP Analysis Duration: 1.48 seconds
Result Aggregation & Global SHAP Duration: 1.61 seconds
Average time per outer fold: 528.71 seconds
--- Nested CV completed for: LightGBM (lgb) ---
Total execution time for model 'lgb': 2645.20 seconds

--- Running Nested CV for: Logistic Regression (logistic) ---
Output directory: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic
Using StratifiedGroupKFold for outer CV with 5 folds based on query IDs and stratified by y.

-- Processing Outer Fold 1/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 150 to 3297
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'model__solver': 'saga', 'model__penalty': 'elasticnet', 'model__max_iter': 2000, 'model__l1_ratio': 0.5, 'model__class_weight': None, 'model__C': 0.000774263682681127}
Best Inner CV PR-AUC score: 0.9134
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_1/best_params.json
CV metrics for best model: PR-AUC=0.9134, ROC-AUC=0.9450, F1=0.0000, Balanced Acc=0.5000
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_1/cv_metrics.json
Hyperparameter Tuning Duration: 13.25 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_1/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_1/predictions.csv
Default threshold (0.5): F1=0.4863
Optimal threshold (0.2623): F1=0.9189
Using optimal threshold (0.2623) for better F1 score
Prediction & Evaluation Duration: 0.19 seconds
Calculating and saving SHAP values...
Calculating SHAP values using shap.Explainer with predict_proba for Pipeline...
Warning: Background data (X_background) not provided. Using 100 samples from X_test.
Returning 2D SHAP values array from shap.Explainer (predict_proba).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_1/shap_values_fold_1.csv (shape: (699, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_1/test_data_fold_1.csv (shape: (699, 63))
SHAP Calculation & Saving Duration: 25.18 seconds
-- Outer Fold 1 finished. Duration: 38.67 seconds --

-- Processing Outer Fold 2/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 50 to 3596
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'model__solver': 'saga', 'model__penalty': 'l1', 'model__max_iter': 2000, 'model__class_weight': None, 'model__C': 0.005994842503189409}
Best Inner CV PR-AUC score: 0.9423
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_2/best_params.json
CV metrics for best model: PR-AUC=0.9423, ROC-AUC=0.9609, F1=0.7959, Balanced Acc=0.8394
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_2/cv_metrics.json
Hyperparameter Tuning Duration: 12.83 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_2/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_2/predictions.csv
Default threshold (0.5): F1=0.5038
Optimal threshold (0.3459): F1=0.6272
Using optimal threshold (0.3459) for better F1 score
Prediction & Evaluation Duration: 0.08 seconds
Calculating and saving SHAP values...
Calculating SHAP values using shap.Explainer with predict_proba for Pipeline...
Warning: Background data (X_background) not provided. Using 100 samples from X_test.
Returning 2D SHAP values array from shap.Explainer (predict_proba).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_2/shap_values_fold_2.csv (shape: (750, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_2/test_data_fold_2.csv (shape: (750, 63))
SHAP Calculation & Saving Duration: 26.79 seconds
-- Outer Fold 2 finished. Duration: 39.73 seconds --

-- Processing Outer Fold 3/5 --
Train set size: (2897, 63), Test set size: (750, 63)
Test set indices range from 100 to 3446
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'model__solver': 'saga', 'model__penalty': 'elasticnet', 'model__max_iter': 1000, 'model__l1_ratio': 0.9, 'model__class_weight': None, 'model__C': 0.046415888336127774}
Best Inner CV PR-AUC score: 0.9387
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_3/best_params.json
CV metrics for best model: PR-AUC=0.9387, ROC-AUC=0.9617, F1=0.8503, Balanced Acc=0.8853
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_3/cv_metrics.json
Hyperparameter Tuning Duration: 14.08 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_3/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_3/predictions.csv
Default threshold (0.5): F1=0.6062
Optimal threshold (0.0973): F1=0.7168
Using optimal threshold (0.0973) for better F1 score
Prediction & Evaluation Duration: 0.08 seconds
Calculating and saving SHAP values...
Calculating SHAP values using shap.Explainer with predict_proba for Pipeline...
Warning: Background data (X_background) not provided. Using 100 samples from X_test.
Returning 2D SHAP values array from shap.Explainer (predict_proba).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_3/shap_values_fold_3.csv (shape: (750, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_3/test_data_fold_3.csv (shape: (750, 63))
SHAP Calculation & Saving Duration: 30.81 seconds
-- Outer Fold 3 finished. Duration: 45.00 seconds --

-- Processing Outer Fold 4/5 --
Train set size: (2898, 63), Test set size: (749, 63)
Test set indices range from 0 to 3546
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'model__solver': 'liblinear', 'model__penalty': 'l1', 'model__class_weight': None, 'model__C': 0.005994842503189409}
Best Inner CV PR-AUC score: 0.9256
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_4/best_params.json
CV metrics for best model: PR-AUC=0.9256, ROC-AUC=0.9485, F1=0.8123, Balanced Acc=0.8600
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_4/cv_metrics.json
Hyperparameter Tuning Duration: 12.79 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_4/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_4/predictions.csv
Default threshold (0.5): F1=0.9353
Optimal threshold (0.6715): F1=0.9512
Prediction & Evaluation Duration: 0.13 seconds
Calculating and saving SHAP values...
Calculating SHAP values using shap.Explainer with predict_proba for Pipeline...
Warning: Background data (X_background) not provided. Using 100 samples from X_test.
Returning 2D SHAP values array from shap.Explainer (predict_proba).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_4/shap_values_fold_4.csv (shape: (749, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_4/test_data_fold_4.csv (shape: (749, 63))
SHAP Calculation & Saving Duration: 27.46 seconds
-- Outer Fold 4 finished. Duration: 40.39 seconds --

-- Processing Outer Fold 5/5 --
Train set size: (2948, 63), Test set size: (699, 63)
Test set indices range from 350 to 3646
Using StratifiedGroupKFold for inner CV with 3 folds.
Starting hyperparameter tuning (RandomizedSearchCV)...
Best Params found: {'model__solver': 'liblinear', 'model__penalty': 'l1', 'model__class_weight': None, 'model__C': 0.005994842503189409}
Best Inner CV PR-AUC score: 0.8894
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_5/best_params.json
CV metrics for best model: PR-AUC=0.8894, ROC-AUC=0.9382, F1=0.7853, Balanced Acc=0.8489
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_5/cv_metrics.json
Hyperparameter Tuning Duration: 12.77 seconds
Predicting on outer test set...
Calculating performance metrics...
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_5/metrics.json
Predictions saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_5/predictions.csv
Default threshold (0.5): F1=0.9036
Optimal threshold (0.2948): F1=0.9206
Prediction & Evaluation Duration: 0.13 seconds
Calculating and saving SHAP values...
Calculating SHAP values using shap.Explainer with predict_proba for Pipeline...
Warning: Background data (X_background) not provided. Using 100 samples from X_test.
Returning 2D SHAP values array from shap.Explainer (predict_proba).
SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_5/shap_values_fold_5.csv (shape: (699, 63))
Test data corresponding to SHAP values saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/fold_5/test_data_fold_5.csv (shape: (699, 63))
SHAP Calculation & Saving Duration: 25.23 seconds
-- Outer Fold 5 finished. Duration: 38.17 seconds --

--- Aggregating results for: Logistic Regression (logistic) ---
Average Metrics across folds:
{
    "accuracy_mean": 0.8526736489854857,
    "accuracy_std": 0.08345967585738695,
    "precision_mean": 0.8402220835283716,
    "precision_std": 0.18489470746010658,
    "recall_mean": 0.6122676385909939,
    "recall_std": 0.2219990149932907,
    "f1_mean": 0.6870462734611424,
    "f1_std": 0.19436323159025864,
    "roc_auc_mean": 0.9370821497307688,
    "roc_auc_std": 0.04817854542423635,
    "pr_auc_mean": 0.8800040645045192,
    "pr_auc_std": 0.11562068017163456,
    "balanced_accuracy_mean": 0.7870462664716747,
    "balanced_accuracy_std": 0.11926028685728703,
    "mcc_mean": 0.6267170019882367,
    "mcc_std": 0.2124656785267787,
    "best_inner_cv_pr_auc_mean": 0.9218738437590789,
    "best_inner_cv_pr_auc_std": 0.01919081402225854,
    "default_threshold_mean": 0.5,
    "default_threshold_std": 0.0,
    "optimal_threshold_mean": 0.33435556867095345,
    "optimal_threshold_std": 0.1880109919123746,
    "optimal_f1_mean": 0.826961289190448,
    "optimal_f1_std": 0.1301541080376721,
    "threshold_improvement_mean": 0.1399150157293055,
    "threshold_improvement_std": 0.15313156440956494
}
Results saved to /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/metrics_summary.json
Combined predictions saved to: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/logistic/all_predictions.csv

Running global SHAP analysis...
Combined SHAP values shape: (3647, 63)
Combined test data shape: (3647, 63)
Global SHAP analysis completed using data from all 5 folds
Global SHAP Analysis Duration: 1.39 seconds
Result Aggregation & Global SHAP Duration: 1.49 seconds
Average time per outer fold: 40.39 seconds
--- Nested CV completed for: Logistic Regression (logistic) ---
Total execution time for model 'logistic': 203.49 seconds

--- Overall Training Summary ---
Model comparison summary saved to: /home/cseomoon/appl/af_analysis-0.1.4/model/classification/results/cls_renewal_20250429_042933/model_comparison_summary.csv
  model_name  accuracy_mean  ...  threshold_used_std                 error
0         rf       0.863684  ...                 0.0                   NaN
1        xgb            NaN  ...                 NaN  No metrics collected
2        lgb       0.859431  ...                 0.0                   NaN
3   logistic       0.852674  ...                 NaN                   NaN

[4 rows x 30 columns]
Final Summary Saving Duration: 0.05 seconds

--- Framework Execution Finished ---
Total script execution time: 3151.75 seconds
 
[INFO] Job completed at: Tue Apr 29 05:22:21 KST 2025
